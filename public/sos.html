<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EMERGENCY SOS | Travel Mate</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <style>
    body {
      background-color: #450a0a;
      /* Dark Red */
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }

    .sos-container {
      text-align: center;
      padding: 2rem;
      max-width: 500px;
      width: 100%;
    }

    .sos-btn-outer {
      width: 240px;
      height: 240px;
      margin: 3rem auto;
      position: relative;
      cursor: pointer;
    }

    .pulse-ring {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background: rgba(239, 68, 68, 0.4);
      animation: ring-pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    .pulse-ring:nth-child(2) {
      animation-delay: 0.5s;
    }

    .sos-btn-main {
      position: absolute;
      inset: 20px;
      background: #ef4444;
      border-radius: 50%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 50px rgba(239, 68, 68, 0.8), inset 0 0 30px rgba(0, 0, 0, 0.2);
      border: 8px solid rgba(255, 255, 255, 0.1);
      color: white;
      z-index: 10;
      transition: var(--transition);
    }

    .sos-btn-main:hover {
      transform: scale(0.95);
      background: #dc2626;
    }

    .sos-btn-main:active {
      transform: scale(0.9);
    }

    @keyframes ring-pulse {
      0% {
        transform: scale(0.8);
        opacity: 0.8;
      }

      100% {
        transform: scale(1.6);
        opacity: 0;
      }
    }

    #sosBtn:disabled {
      background: #1e293b;
      box-shadow: none;
      cursor: not-allowed;
      animation: none;
    }

    .emergency-header {
      animation: bounce 1s infinite alternate;
    }

    @keyframes bounce {
      from {
        transform: translateY(0);
      }

      to {
        transform: translateY(-10px);
      }
    }
  </style>
</head>

<body>

  <div class="sos-container">
    <div class="emergency-header">
      <i class="ph ph-warning-octagon" style="font-size: 4rem; color: #ef4444;"></i>
      <h1 style="margin-top: 1rem; color: #fff; -webkit-text-fill-color: white;">EMERGENCY SOS</h1>
    </div>

    <p style="color: #fecaca; font-size: 1.1rem;">
      Immediate assistance will be dispatched.
    </p>

    <form id="sosForm" action="https://formspree.io/f/xyzdkdap" method="POST">
      <input type="hidden" name="_subject" value="ðŸš¨ EMERGENCY SOS ALERT">
      <input type="hidden" name="_captcha" value="false">
      <input type="hidden" name="_replyto" id="replyto">
      <input type="hidden" name="name" id="name">
      <input type="hidden" name="phone" id="phone">
      <input type="hidden" name="place" id="place">
      <input type="hidden" name="message" id="message">

      <div class="sos-btn-outer" onclick="handleSOSClick()">
        <div class="pulse-ring"></div>
        <div class="pulse-ring"></div>
        <div class="sos-btn-main" id="sosVisual">
          <span style="font-size: 3rem; font-weight: 900;">SOS</span>
          <span style="font-size: 0.875rem; font-weight: 600;">TAP TO TRIGGER</span>
        </div>
      </div>

      <button type="submit" id="actualSubmit" style="display: none;"></button>
    </form>

    <div style="margin-top: 2rem;">
      <p style="color: #991b1b; background: #fee2e2; padding: 1rem; border-radius: 1rem; font-weight: 600;">
        <i class="ph ph-shield-check"></i> Connected to Local Police HQ
      </p>
    </div>

    <a href="dashboard.html" id="cancelLink"
      style="color: #fecaca; text-decoration: none; display: inline-block; margin-top: 2rem;">
      <i class="ph ph-x-circle"></i> CANCEL & BACK
    </a>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const name = params.get('name') || 'Unknown';
    const userEmail = params.get('email');
    const phone = params.get('phone') || 'Not Provided';
    const place = params.get('place') || 'Unknown Location';

    const safeEmail = userEmail && userEmail.includes('@') ? userEmail : 'noreply@sos-system.com';

    document.getElementById('replyto').value = safeEmail;
    document.getElementById('name').value = name;
    document.getElementById('phone').value = phone;
    document.getElementById('place').value = place;
    document.getElementById('cancelLink').href = `dashboard.html?name=${name}&email=${userEmail}&phone=${phone}`;

    document.getElementById('message').value = `ðŸš¨ EMERGENCY SOS ALERT ðŸš¨\n\nName: ${name}\nEmail: ${userEmail}\nPhone: ${phone}\nLocation: ${place}\n\nImmediate assistance required!`;

    async function handleSOSClick() {
      if (confirm("ðŸš¨ TRIGGER EMERGENCY SOS?\nThis will notify local authorities and your trust circle.")) {
        const visual = document.getElementById('sosVisual');

        // Get Geolocation
        let lat = 0, lon = 0;
        try {
          const pos = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(res, rej));
          lat = pos.coords.latitude;
          lon = pos.coords.longitude;
        } catch (e) { console.log("Geo blocked"); }

        // Alert Internal System
        try {
          await fetch('/api/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              email: userEmail,
              name,
              phone,
              place,
              latitude: lat,
              longitude: lon
            })
          });
        } catch (e) { console.error("Internal Log Error", e); }

        visual.style.background = "#15803d"; // Green
        visual.innerHTML = '<i class="ph ph-check-circle" style="font-size: 4rem;"></i><span style="font-weight: 700;">HELP SENT</span>';

        setTimeout(() => {
          document.getElementById('actualSubmit').click();
        }, 1000);
      }
    }
  </script>
</body>

</html>